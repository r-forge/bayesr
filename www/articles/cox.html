<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Complex Space-Time Interactions in a Cox Model • bamlss</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Complex Space-Time Interactions in a Cox Model">
<meta property="og:description" content="bamlss">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bamlss</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1-9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bamlss.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/terms.html">Available Model Terms</a>
    </li>
    <li>
      <a href="../articles/families.html">Families</a>
    </li>
    <li>
      <a href="../articles/bf.html">BAMLSS Model Frame</a>
    </li>
    <li>
      <a href="../articles/engines.html">Estimation Engines</a>
    </li>
    <li>
      <a href="../articles/distregvis.html">Visualization with distreg.vis</a>
    </li>
    <li>
      <a href="../articles/glm.html">Generalized Linear Models (+)</a>
    </li>
    <li>
      <a href="../articles/multinomial.html">Bayesian Multinomial Regression</a>
    </li>
    <li>
      <a href="../articles/rent.html">Munich Rent Example</a>
    </li>
    <li>
      <a href="../articles/zn.html">Spatial Location-Scale Model</a>
    </li>
    <li>
      <a href="../articles/fatalities.html">Fatalities Model for Austria</a>
    </li>
    <li>
      <a href="../articles/mvnorm.html">Multivariate Normal Model</a>
    </li>
    <li>
      <a href="../articles/misc.html">Miscellaneous Topics</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Publications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/jm.html">Bayesian Joint Models for Longitudinal and Survival Data</a>
    </li>
    <li>
      <a href="../articles/bivnorm.html">Bivariate Gaussian Models for Wind Vectors</a>
    </li>
    <li>
      <a href="../articles/cox.html">Complex Space-Time Interactions in a Cox Model</a>
    </li>
    <li>
      <a href="../articles/lasso.html">LASSO-Type Penalization in the Framework of GAMLSS</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Complex Space-Time Interactions in a Cox
Model</h1>
            
      
      
      <div class="hidden name"><code>cox.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="intro">Intro<a class="anchor" aria-label="anchor" href="#intro"></a>
</h2>
<p>In the article <strong>BAMLSS: Bayesian Additive Models for Location,
Scale, and Shape (and Beyond)</strong> <span class="citation">(Umlauf,
Klein, and Zeileis 2018)</span> an example based on the article of <span class="citation">Taylor (2017)</span> is used to illustrate the BAMLSS
framework with complex space-time interactions in a Cox model.</p>
<p>The example uses data from the <em>London Fire Brigade</em> (LFB, <a href="http://www.london-fire.gov.uk/" class="external-link">http://www.london-fire.gov.uk/</a>),
which is one of largest fire brigades in the world. Each year, the LFB
is called thousands of times, in most cases due to dwelling fires. To
prevent further damage or fatal casualties, a short arrival time is
important, i.e., the time it takes until a fire engine arrives at the
scene after an emergency call has been received. The aim of this
analysis is to explore the drivers of arrival times.</p>
</div>
<div class="section level2">
<h2 id="model">Model<a class="anchor" aria-label="anchor" href="#model"></a>
</h2>
<p>The response times are analyzed within a survival context where the
hazard of an event (fire engine arriving) at time <span class="math inline">\(t\)</span> follows a relative risk model of the
form <span class="math display">\[
\lambda(t) = \exp\left(\eta(t)\right) =  \exp\left( \eta_{\lambda}(t) +
\eta_{\gamma} \right),
\]</span> i.e., a model for the instantaneous arrival rate conditional
on the engine not having arrived before time <span class="math inline">\(t\)</span>. Here, the hazard function is assumed
to depend on a time-varying predictor <span class="math inline">\(\eta_{\lambda}(t)\)</span> and a time-constant
predictor <span class="math inline">\(\eta_{\gamma}\)</span>.</p>
<p>We set up a model with the time-constant predictor <span class="math display">\[
\eta_{\gamma} = \beta_0 + f_1(\texttt{fsintens}) + f_2(\texttt{daytime})
+
  f_3(\texttt{lon}, \texttt{lat}) + f_4(\texttt{daytime}, \texttt{lon},
\texttt{lat}),
\]</span> where <span class="math inline">\(\beta_0\)</span> is an
intercept and function <span class="math inline">\(f_1( \cdot )\)</span>
is the effect of fire station intensity (<code>fsintens</code>, computed
with a kernel density estimate of all fire stations in London). The
other variables represent: The time of the day (<code>daytime</code>),
exact spatial coordinates of the fire (<code>lon</code> and
<code>lat</code>). Here function <span class="math inline">\(f_4( \cdot
)\)</span> is a three-dimensional interaction effect.</p>
<p>The time-varying additive predictor has the following form <span class="math display">\[
\eta_{\lambda}(\texttt{arrivaltime}) = f_0(\texttt{arrivaltime}) +
f_1(\texttt{arrivaltime}, \texttt{lon}, \texttt{lat}),
\]</span> where <span class="math inline">\(f_0( \cdot )\)</span> is the
baseline hazard for variable <code>arrivaltime</code>, the waiting time
until the first fire engine arrives after the received emergency
call.</p>
<p>The probability that the engine will arrive on the scene after time
<span class="math inline">\(t\)</span> is described by the survival
function <span class="math display">\[\begin{equation} \label{eqn:surv}
S(t) = \mathrm{Prob}(T &gt; t) = \exp \, \left( -\int_0^t \lambda(u)du
\right),
\end{equation}\]</span> which is of prime interest in this analysis.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The data is freely available from the London DataStore (<a href="http://data.london.gov.uk/" class="external-link">http://data.london.gov.uk/</a>) under
the UK Open Government Licence (OGL v2). It can be downloaded from <a href="http://data.london.gov.uk/dataset/london-fire-brigade-incident-records" class="external-link">http://data.london.gov.uk/dataset/london-fire-brigade-incident-records</a>
which also contains previous years. The preprocessed data is part of the
<em>bamlss</em> package and can be loaded with</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">LondonFire</span>, package <span class="op">=</span> <span class="st">"bamlss"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">LondonFire</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##                   coordinates arrivaltime   daytime  fsintens</span>
<span class="co">## 12279 (-0.09832153, 51.65413)    6.033333 0.1263889  248.6067</span>
<span class="co">## 12280 (-0.04467665, 51.48959)    3.400000 0.3266667 1646.1975</span>
<span class="co">## 12281  (-0.1101969, 51.47268)    4.383333 0.4641667 1333.3776</span>
<span class="co">## 12282  (-0.2448571, 51.45319)    5.800000 1.9297222  300.6900</span>
<span class="co">## 12283  (-0.1874054, 51.48648)    5.133333 1.9308333 1195.7156</span>
<span class="co">## 12284  (-0.2893525, 51.61031)    4.966667 3.5480556  319.6787</span></code></pre>
<p>and is stored as a <code>"SpatialPointsDataFrame"</code>. Therefore,
the spatial distribution of fires in London along with boundary polygons
and station locations can be plotted instantly with:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/edzer/sp/" class="external-link">"sp"</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LondonBoundaries</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LondonFire</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LondonBoroughs</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">LondonFStations</span>, col <span class="op">=</span> <span class="st">"blue"</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-2-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>The Cox model is implemented in the <code><a href="../reference/family.bamlss.html">cox_bamlss()</a></code> family
and uses a special optimizer function <code><a href="../reference/cox.mode.html">cox_mode()</a></code> and
sampling engine <code><a href="../reference/cox.mcmc.html">cox_mcmc()</a></code>. Note that the optimizer and
sampler function do not need to be called explicitly within the
<code><a href="../reference/bamlss.html">bamlss()</a></code> wrapper call, because the
<code><a href="../reference/family.bamlss.html">cox_bamlss()</a></code> family specifies this already in its return
value, such that internally function <code><a href="../reference/bamlss.html">bamlss()</a></code> nows to only
use the estimation engines that are supplied by the family.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/family.bamlss.html">cox_bamlss</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fam</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "family"    "names"     "links"     "transform" "optimizer" "sampler"  </span>
<span class="co">## [7] "predict"</span></code></pre>
<p>There is also an additional transformer function, which is needed for
computing the (numerical) integrals that are part of the log-likelihood.
Predictions are also based on integrals, therefore the
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function is also part of this family object and
will be used by <code><a href="../reference/predict.bamlss.html">predict.bamlss()</a></code> instead of the default
methods.</p>
<p>The model formula has two parts, the time-dependent for <span class="math inline">\(\eta_{\lambda}\)</span> and the time-constant part
for <span class="math inline">\(\eta_{\gamma}\)</span> and can be set up
with</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">arrivaltime</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></span><span class="op">(</span><span class="va">arrivaltime</span>,k<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></span><span class="op">(</span><span class="va">arrivaltime</span>,<span class="va">lon</span>,<span class="va">lat</span>,d<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,k<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span>,
  <span class="va">gamma</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">fsintens</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></span><span class="op">(</span><span class="va">daytime</span>,bs<span class="op">=</span><span class="st">"cc"</span>,k<span class="op">=</span><span class="fl">30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></span><span class="op">(</span><span class="va">lon</span>,<span class="va">lat</span>,k<span class="op">=</span><span class="fl">80</span>,d<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/te.html" class="external-link">ti</a></span><span class="op">(</span><span class="va">daytime</span>,<span class="va">lon</span>,<span class="va">lat</span>,bs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cc"</span>,<span class="st">"cr"</span><span class="op">)</span>,d<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>,k<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">30</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Note that the <code><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv()</a></code> function from the <em>survival</em>
package <span class="citation">(Therneau 2019)</span> is used to set up
the formula for <span class="math inline">\(\eta_{\lambda}\)</span>.
Also note that the arrival times are not censored in this application.
The model is estimated with</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Set the seed for reproducibility.</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">222</span><span class="op">)</span>

<span class="co">## Start estimation</span>
<span class="va">firemodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bamlss.html">bamlss</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">LondonFire</span>, family <span class="op">=</span> <span class="st">"cox"</span>,
  subdivisions <span class="op">=</span> <span class="fl">25</span>, maxit <span class="op">=</span> <span class="fl">1000</span>,
  n.iter <span class="op">=</span> <span class="fl">6000</span>, burnin <span class="op">=</span> <span class="fl">3000</span>, thin <span class="op">=</span> <span class="fl">20</span>, cores <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></code></pre></div>
<p>Note, due to the complexity of the model and model terms estimation
takes quite long. On a Linux system with 8 Intel i7-2600 3.40GHz
processors estimation takes approximately 1.2 days.</p>
<p>Good practice after fitting the model is to do some convergence
checks of the MCMC chains, e.g., by looking at traceplots</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">firemodel</span>, which <span class="op">=</span> <span class="st">"samples"</span><span class="op">)</span></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-7-1.png" width="80%" style="display: block; margin: auto;">
Note, for convenience we only show the traceplot of the intercept term
of predictor <span class="math inline">\(\eta_{\gamma}\)</span>. The
traceplot indicates convergence of the MCMC chains and have close to
i.i.d. behavior. The model summary gives</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">firemodel</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">## Call:</span>
<span class="co">## bamlss(formula = f, family = "cox", data = LondonFire, cores = 8, </span>
<span class="co">##     subdivisions = 25, maxit = 1000, n.iter = 6000, burnin = 3000, </span>
<span class="co">##     thin = 20)</span>
<span class="co">## ---</span>
<span class="co">## Family: cox </span>
<span class="co">## Link function: lambda = log, gamma = log</span>
<span class="co">## *---</span>
<span class="co">## Formula lambda:</span>
<span class="co">## ---</span>
<span class="co">## Surv(arrivaltime) ~ ti(arrivaltime, k = 20) + ti(arrivaltime, </span>
<span class="co">##     lon, lat, d = c(1, 2), k = c(5, 30))</span>
<span class="co">## -</span>
<span class="co">## Smooth terms:</span>
<span class="co">##                                    Mean      2.5%       50%     97.5%</span>
<span class="co">## ti(arrivaltime).tau21         2.087e-02 5.443e-03 1.717e-02 5.698e-02</span>
<span class="co">## ti(arrivaltime).edf           1.319e+01 1.061e+01 1.317e+01 1.585e+01</span>
<span class="co">## ti(arrivaltime).alpha         7.017e-01 7.428e-04 8.238e-01 1.000e+00</span>
<span class="co">## ti(arrivaltime,lon,lat).tau21 2.742e-03 3.547e-05 1.731e-04 6.251e-03</span>
<span class="co">## ti(arrivaltime,lon,lat).tau22 1.256e+02 3.188e+01 1.062e+02 3.061e+02</span>
<span class="co">## ti(arrivaltime,lon,lat).edf   1.369e+01 8.909e+00 1.360e+01 1.839e+01</span>
<span class="co">## ti(arrivaltime,lon,lat).alpha 7.107e-01 1.755e-03 8.394e-01 1.000e+00</span>
<span class="co">##                               parameters</span>
<span class="co">## ti(arrivaltime).tau21              0.117</span>
<span class="co">## ti(arrivaltime).edf               16.853</span>
<span class="co">## ti(arrivaltime).alpha                 NA</span>
<span class="co">## ti(arrivaltime,lon,lat).tau21      1.442</span>
<span class="co">## ti(arrivaltime,lon,lat).tau22    100.714</span>
<span class="co">## ti(arrivaltime,lon,lat).edf       24.858</span>
<span class="co">## ti(arrivaltime,lon,lat).alpha         NA</span>
<span class="co">## ---</span>
<span class="co">## Formula gamma:</span>
<span class="co">## ---</span>
<span class="co">## gamma ~ s(fsintens) + ti(daytime, bs = "cc", k = 30) + ti(lon, </span>
<span class="co">##     lat, k = 80, d = 2) + ti(daytime, lon, lat, bs = c("cc", </span>
<span class="co">##     "cr"), d = c(1, 2), k = c(10, 30))</span>
<span class="co">## -</span>
<span class="co">## Parametric coefficients:</span>
<span class="co">##                Mean    2.5%     50%   97.5% parameters</span>
<span class="co">## (Intercept) -0.9501 -0.9773 -0.9499 -0.9234     -0.941</span>
<span class="co">## -</span>
<span class="co">## Acceptance probability:</span>
<span class="co">##         Mean   2.5%    50% 97.5%</span>
<span class="co">## alpha 0.9932 0.9398 0.9999     1</span>
<span class="co">## -</span>
<span class="co">## Smooth terms:</span>
<span class="co">##                                Mean      2.5%       50%     97.5% parameters</span>
<span class="co">## s(fsintens).tau21         9.083e+00 1.746e+00 6.596e+00 2.919e+01      8.171</span>
<span class="co">## s(fsintens).edf           7.381e+00 5.954e+00 7.439e+00 8.504e+00      7.638</span>
<span class="co">## s(fsintens).alpha         9.048e-01 4.122e-01 9.785e-01 1.000e+00         NA</span>
<span class="co">## ti(daytime).tau21         3.385e-02 1.703e-04 8.700e-04 4.559e-02      0.000</span>
<span class="co">## ti(daytime).edf           1.094e+01 6.215e+00 9.916e+00 2.201e+01      6.461</span>
<span class="co">## ti(daytime).alpha         9.176e-01 5.090e-01 9.856e-01 1.000e+00         NA</span>
<span class="co">## ti(lon,lat).tau21         4.313e+00 2.161e+00 4.049e+00 7.642e+00      7.714</span>
<span class="co">## ti(lon,lat).edf           5.794e+01 4.940e+01 5.806e+01 6.489e+01     65.221</span>
<span class="co">## ti(lon,lat).alpha         4.695e-01 1.428e-03 3.702e-01 1.000e+00         NA</span>
<span class="co">## ti(daytime,lon,lat).tau21 3.245e+00 2.595e-01 1.928e+00 1.464e+01      0.000</span>
<span class="co">## ti(daytime,lon,lat).tau22 5.289e+00 8.305e-01 3.856e+00 1.770e+01      0.000</span>
<span class="co">## ti(daytime,lon,lat).edf   3.846e+01 2.034e+01 3.763e+01 6.181e+01      0.013</span>
<span class="co">## ti(daytime,lon,lat).alpha 7.939e-01 1.493e-01 9.154e-01 1.000e+00         NA</span>
<span class="co">## ---</span>
<span class="co">## Sampler summary:</span>
<span class="co">## -</span>
<span class="co">## DIC = 22636.5 logLik = -11247.03 logPost = -10031.52</span>
<span class="co">## pd = 142.4373</span>
<span class="co">## ---</span>
<span class="co">## Optimizer summary:</span>
<span class="co">## -</span>
<span class="co">## AICc = 22607.29 edf = 122.0436 logLik = -11178.97</span>
<span class="co">## logPost = -8898.27 time = 14443.76</span>
<span class="co">## ---</span></code></pre>
<p>and indicates that the three-dimensional effects in
<code>lambda</code> and <code>gamma</code> have an effect on the
response times. The estimated effects can be plotted with</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">4</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">firemodel</span>, scale <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-10-1.png" width="80%" style="display: block; margin: auto;">
The upper left plot shows the estimated baseline hazard effect. The
upper right plot the time-constant effect of fire station intensity. The
lower left plot the estimated effect of the time of the day and the
lower right plot the estimated time-constant spatial effect.</p>
</div>
<div class="section level2">
<h2 id="prediction">Prediction<a class="anchor" aria-label="anchor" href="#prediction"></a>
</h2>
<p>Predictions in for an estimated Cox model are based on the custom
predict function <code><a href="../reference/cox.predict.html">cox_predict()</a></code>. Here, predicted
probabilities are based on numerical integration, therefore, the user
can specify the subdivisions that are used in the integration routine.
For example, let’s pick a sample location within the boundaries of
London and predict the corresponding probability that the fire engine
arrives at 15pm within 0 to 20 minutes.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Extract the 150th sample.</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">150</span>

<span class="co">## Create a new data frame for prediction.</span>
<span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
  <span class="st">"arrivaltime"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,
  <span class="st">"daytime"</span> <span class="op">=</span> <span class="fl">15</span>
<span class="op">)</span>
<span class="va">nd</span><span class="op">$</span><span class="va">fsintens</span> <span class="op">&lt;-</span> <span class="va">LondonFire</span><span class="op">$</span><span class="va">fsintens</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">nd</span><span class="op">$</span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="va">LondonFire</span><span class="op">$</span><span class="va">lon</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
<span class="va">nd</span><span class="op">$</span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="va">LondonFire</span><span class="op">$</span><span class="va">lat</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>

<span class="co">## Predict probabilities.</span>
<span class="va">nd</span><span class="op">$</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">firemodel</span>, newdata <span class="op">=</span> <span class="va">nd</span>,
  type <span class="op">=</span> <span class="st">"probabilities"</span>, subdivisions <span class="op">=</span> <span class="fl">100</span>, FUN <span class="op">=</span> <span class="va">c95</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The estimated probabilities that the fire engine arrives in <span class="math inline">\(t\)</span> minutes can then be plotted with</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot2d.html">plot2d</a></span><span class="op">(</span><span class="va">p</span> <span class="op">~</span> <span class="va">arrivaltime</span>, data <span class="op">=</span> <span class="va">nd</span>, ylab <span class="op">=</span> <span class="st">"1 - Prob(T &gt; t)"</span><span class="op">)</span></code></pre></div>
<p><img src="cox_files/figure-html/unnamed-chunk-12-1.png" width="50%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bamlss:Taylor:2015" class="csl-entry">
Taylor, Benjamin M. 2017. <span>“Spatial Modelling of Emergency Service
Response Times.”</span> <em>Journal of the Royal Statistical Society
A</em>. <a href="https://doi.org/10.1111/rssa.12192" class="external-link">https://doi.org/10.1111/rssa.12192</a>.
</div>
<div id="ref-bamlss:Therneau:2016" class="csl-entry">
Therneau, T. M. 2019. <em><span class="nocase">survival</span>: A
Package for Survival Analysis in s</em>. <a href="https://CRAN.R-project.org/package=survival" class="external-link">https://CRAN.R-project.org/package=survival</a>.
</div>
<div id="ref-bamlss:Umlauf+Klein+Zeileis:2017" class="csl-entry">
Umlauf, Nikolaus, Nadja Klein, and Achim Zeileis. 2018.
<span>“<span>BAMLSS</span>: <span>B</span>ayesian Additive Models for
Location, Scale and Shape (and Beyond).”</span> <em>Journal of
Computational and Graphical Statistics</em> 27 (3): 612–27. <a href="https://doi.org/10.1080/10618600.2017.1407325" class="external-link">https://doi.org/10.1080/10618600.2017.1407325</a>.
</div>
<div id="ref-bamlss:Umlauf+bamlss:2018" class="csl-entry">
Umlauf, Nikolaus, Nadja Klein, Achim Zeileis, and Thorsten Simon. 2021.
<em><span class="nocase">bamlss</span>: <span>B</span>ayesian Additive
Models for Location Scale and Shape (and Beyond)</em>. <a href="https://CRAN.R-project.org/package=bamlss" class="external-link">https://CRAN.R-project.org/package=bamlss</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Nikolaus Umlauf, Nadja Klein, Achim Zeileis, Thorsten Simon.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
