<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Available Model Terms • bamlss</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Available Model Terms">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bamlss</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bamlss.html">Get started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/terms.html">Available Model Terms</a>
    </li>
    <li>
      <a href="../articles/glm.html">Generalized Linear Models (+)</a>
    </li>
    <li>
      <a href="../articles/families.html">Families</a>
    </li>
    <li>
      <a href="../articles/distregvis.html">Visualization with distreg.vis</a>
    </li>
    <li>
      <a href="../articles/rent.html">Munich Rent Example</a>
    </li>
    <li>
      <a href="../articles/engines.html">Estimation Engines</a>
    </li>
    <li>
      <a href="../articles/bf.html">BAMLSS Model Frame</a>
    </li>
    <li>
      <a href="../articles/misc.html">Miscellaneous Topics</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Publications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bivnorm.html">Bivariate Gaussian Models for Wind Vectors</a>
    </li>
    <li>
      <a href="../articles/lasso.html">LASSO-Type Penalization in the Framework of GAMLSS</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Available Model Terms</h1>
            
      
      
      <div class="hidden name"><code>terms.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The <em>bamlss</em> package heavily builds upon the R package <em>mgcv</em> <span class="citation">(S. N. Wood 2019)</span> infrastructures, i.e., all model terms that are provided by <em>mgcv</em> can also be used in <em>bamlss</em>. As a consequence, it is also possible to write user defined model terms using the generic <code><a href="../reference/smooth.construct.html">smooth.construct()</a></code>method of <em>mgcv</em>. Moreover, users can in principle even extent this, writing model terms beyond <em>mgcv</em> framework. However, this is a bit more technical and assumes that the user has a good basic knowledge of the internal structure of the package and is only very briefly discussed in this article.</p>
</div>
<div id="specification" class="section level2">
<h2 class="hasAnchor">
<a href="#specification" class="anchor"></a>Specification</h2>
<p>To give an overview of users not familiar with <em>mgcv</em>, the following table lists some model specifications using R’s formula syntax:</p>
<table class="table">
<colgroup>
<col width="6%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">Description</th>
<th align="left">Formula</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Linear effects <span class="math inline">\(\mathbf{X}\boldsymbol{\beta}\)</span>
</td>
<td align="left"><code>~ x1 + x2 + x3</code></td>
</tr>
<tr class="even">
<td align="left">Nonlinear effects of continuous covariates <span class="math inline">\(f(\mathbf{x}) = f(x_1)\)</span>
</td>
<td align="left"><code>~ s(x1)</code></td>
</tr>
<tr class="odd">
<td align="left">Two-dimensional surfaces <span class="math inline">\(f(\mathbf{x}) = f(x_1, x_2)\)</span>
</td>
<td align="left">
<code>~ s(x1,x2)</code>, <code>~ te(x1,x2)</code> or <code>~ ti(x1,x2)</code> (higher dimensional terms possible)</td>
</tr>
<tr class="even">
<td align="left">Spatially correlated effects <span class="math inline">\(f(\mathbf{x}) = f_{spat}(x_s)\)</span>
</td>
<td align="left">
<code>~ s(xs,bs="mrf",xt=list(penalty=K))</code>, where <code>xs</code> is a factor indicating the discrete regional information and <code>K</code> is a supplied penalty matrix. Other options within the <code>xt</code> argument are possible, please see the documentation of <code>smooth.construct.mrf.smooth.spec()</code>
</td>
</tr>
<tr class="odd">
<td align="left">Varying coefficients <span class="math inline">\(f(\mathbf{x}) = x_1f(x_2)\)</span>
</td>
<td align="left"><code>~ s(x2,by=x1)</code></td>
</tr>
<tr class="even">
<td align="left">Spatially varying effects <span class="math inline">\(f(\mathbf{x}) = x_1f_{spat}(x_s)\)</span> or <span class="math inline">\(f(\mathbf{x}) = x_1f(x_2, x_3)\)</span>
</td>
<td align="left">
<code>~ s(xs,bs="mrf",xt=list(penalty=K),by=x1)</code>, <code>~ s(x2,x3,by=x1)</code> or <code>~ te(x2,x3,by=x1)</code>
</td>
</tr>
<tr class="odd">
<td align="left">Random intercepts with cluster index <span class="math inline">\(c\)</span>: <span class="math inline">\(f(\mathbf{x}) = \beta_c\)</span>
</td>
<td align="left">
<code>~ s(id,bs="re")</code>, where <code>id</code> is a factor of cluster indices</td>
</tr>
<tr class="even">
<td align="left">Random slopes with cluster index <span class="math inline">\(c\)</span>: <span class="math inline">\(f(\mathbf{x}) = x_1\beta_c\)</span>
</td>
<td align="left">
<code>~ s(id,x1,bs="re")</code>, as above with continuous covariate <code>x1</code>
</td>
</tr>
</tbody>
</table>
<p>Note that each model term constructor has an argument called <code>bs</code>, which specifies the type of basis that should be used for modeling. For more details on the smooth constructors, please visit the <em>mgcv</em> manual pages of <code>s()</code>, <code>te()</code> and <code>ti()</code>.</p>
</div>
<div id="basics" class="section level2">
<h2 class="hasAnchor">
<a href="#basics" class="anchor"></a>Basics</h2>
<p>To better introduce the standard types of model terms we use simulated data that is part of the <em>bamlss</em> package. The data contains of a couple of different response types and is usually used for internal tests, only.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d &lt;-<span class="st"> </span><span class="kw"><a href="../reference/GAMart.html">GAMart</a></span>()
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(d))</code></pre></div>
<pre><code>##            num     pnum      bnum cnum bin    cat       cens          eta
## 1  0.341704542 2.317364 0.6462574   65 yes   high 1.50241790  0.313833175
## 2 -0.373302161 1.602357 0.3009252   30  no   none 0.00000000 -0.207359234
## 3  0.007432787 1.983092 0.4848116   48  no    low 0.00000000  0.006957129
## 4  0.163871126 2.139531 0.5603679   56 yes medium 0.07999916  0.152055884
## 5 -0.096522673 1.879137 0.4346035   43  no    low 0.91605636 -0.195067241
## 6  0.505487688 2.481147 0.7253611   73 yes   high 1.28712357  0.668382608
##          x1         x2        x3    fac id       lon       lat
## 1 0.2875775 0.35360608 0.2736227   high  1 0.3181818 0.8636364
## 2 0.7883051 0.36644144 0.5938669 medium  2 0.6363636 0.3636364
## 3 0.4089769 0.28710013 0.1601848 medium  3 0.2727273 0.3636364
## 4 0.8830174 0.07997291 0.8534302 medium  4 0.5909091 0.9090909
## 5 0.9404673 0.36545427 0.8477392   high  5 0.4090909 0.7272727
## 6 0.0455565 0.17801381 0.4778868 medium  6 0.6818182 0.3636364
##             err
## 1  0.0278713673
## 2 -0.1659429266
## 3  0.0004756581
## 4  0.0118152420
## 5  0.0985445686
## 6 -0.1628949195</code></pre>
<p>The first column holding variable <code>num</code> is a Gaussian response, all subsequent columns up to variable <code>cens</code> are basically transformations of variable <code>num</code>. Variables <code>x1</code> to <code>lat</code> are covariates, which we use for illustrating how to set up the different model terms in the following.</p>
<p>Let’s start with a simple example using three covariates for a Gaussian model with possible nonlinear influence on the response distribution. The model formula can be specified by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
  num ~<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3),
  sigma ~<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3)
)</code></pre></div>
<p>Note that the default basis function type in <em>mgcv</em> are thin plate regression splines <span class="citation">(Simon N. Wood 2003)</span> using <code>k = 10</code> basis functions per default. Setting <code>k = 10</code> is reasonable in most cases, but this may not be enough for very complex functional forms.</p>
<p>The type of basis in <em>mgcv</em> is selected with the <code>bs</code> argument. There are a number of different basis types readily available, from P-splines <span class="citation">(Eilers and Marx 1996)</span> to Markov random fields, this is documented on the <em>mgcv</em> manual page <code>?smooth.terms</code>. Setting up the smooth terms is relatively straightforward when already known one. For example, if one is interested in specifying interaction terms, e.g., with main effects and interaction using two covariates, we could do the following using tensor product splines</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
  num ~<span class="st"> </span><span class="kw">ti</span>(x1) +<span class="st"> </span><span class="kw">ti</span>(x2) +<span class="st"> </span><span class="kw">ti</span>(x1,x2),
  sigma ~<span class="st"> </span><span class="kw">s</span>(x1) +<span class="st"> </span><span class="kw">s</span>(x2) +<span class="st"> </span><span class="kw">s</span>(x3)
)</code></pre></div>
<p>Here, we use a functional decomposition of the effects of covariates <code>x1</code> and <code>x2</code> in the first formula. Note again that the number of basis function within <code>ti()</code> is again small, <code>k = 5</code>. The reason is, that constructing tensor product model terms can easily end up with thousands of parameters, i.e., these type of model terms need to be specified with care.</p>
</div>
<div id="mrfs" class="section level2">
<h2 class="hasAnchor">
<a href="#mrfs" class="anchor"></a>Markov Random Fields</h2>
<p>Markov random fields (MRF) can be used to model spatially correlated effects using discrete locational observations. However, setting up MRFs can be a bit tricky, so I would like to illustrate the process with a short example. In the simulated data from above, we artificially sample from spatial locations, see the plot of the coordinates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(lat ~<span class="st"> </span>lon, <span class="dt">data =</span> d)</code></pre></div>
<p><img src="terms_files/figure-html/unnamed-chunk-5-1.png" width="432" style="display: block; margin: auto;"> Let’s suppose we only have the coordinates of the locations. Sure, we could directly model the spatial effect using some 2D smoother, e.g., with thin plate regression splines. In most situations spatial information is available as region identifier, but for illustrating the full path, it is a good exercise to start from exact locations. Now, either we have a map available, or we can create polygon grid over the observations, e.g., a hexagonal grid using the <em>spdep</em> and <em>rgeos</em> package</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"spdep"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"rgeos"</span>)

## First, create convex hull of points.
i &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/chull">chull</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">as.matrix</a></span>(d[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]))
co_hull &lt;-<span class="st"> </span>d[i, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]

## Create spatial polygon object.
hullpoly &lt;-<span class="st"> </span><span class="kw">SpatialPolygons</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw">Polygons</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw">Polygon</span>(co_hull)), <span class="dt">ID=</span><span class="dv">1</span>)))

## Expand the polygon just slightly to have all points
## within hexagonal polygons later.
hullpoly_large &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgeos/topics/misc-gBuffer">gBuffer</a></span>(hullpoly, <span class="dt">width =</span> <span class="fl">0.3</span>)

## Sample from large polygon 200 hexagonal polygons.
pts &lt;-<span class="st"> </span><span class="kw">spsample</span>(hullpoly_large, <span class="dt">n =</span> <span class="dv">200</span>, <span class="dt">type =</span> <span class="st">"hexagonal"</span>, <span class="dt">offset =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>))

## Create final polygons.
hexpolys &lt;-<span class="st"> </span><span class="kw">HexPoints2SpatialPolygons</span>(pts)

## Does not produce a nice map yet.
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.5</span>, <span class="dv">4</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(hullpoly)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(hexpolys, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/points">points</a></span>(d[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</code></pre></div>
<p><img src="terms_files/figure-html/unnamed-chunk-6-1.png" width="432" style="display: block; margin: auto;"> Now, note that the hexagonal polygons do not intersect correctly with the polygon of the convex hull. To achieve this, we again need the <em>rgeos</em> package</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Intersect with convex hull polygon.
hexpolys &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgeos/topics/topo-bin-gIntersection">gIntersection</a></span>(hullpoly, hexpolys, <span class="dt">byid =</span> <span class="ot">TRUE</span>, <span class="dt">drop_lower_td =</span> <span class="ot">TRUE</span>)

## Plot the intersections.
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.5</span>, <span class="dv">4</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(hullpoly)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(hexpolys, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/points">points</a></span>(d[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)])</code></pre></div>
<p><img src="terms_files/figure-html/unnamed-chunk-7-1.png" width="432" style="display: block; margin: auto;"> We only need to assign polygon ID’s to the individual observations in the data frame to set up a MRF smooth.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d$ID &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/plotmath">over</a></span>(<span class="kw">SpatialPoints</span>(d[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]), hexpolys)

## Note, over() only returns the index of the polygons,
## but for the MRF we need the polygon names.
d$ID &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(hexpolys)[d$ID])
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(d))</code></pre></div>
<pre><code>##            num     pnum      bnum cnum bin    cat       cens          eta
## 1  0.341704542 2.317364 0.6462574   65 yes   high 1.50241790  0.313833175
## 2 -0.373302161 1.602357 0.3009252   30  no   none 0.00000000 -0.207359234
## 3  0.007432787 1.983092 0.4848116   48  no    low 0.00000000  0.006957129
## 4  0.163871126 2.139531 0.5603679   56 yes medium 0.07999916  0.152055884
## 5 -0.096522673 1.879137 0.4346035   43  no    low 0.91605636 -0.195067241
## 6  0.505487688 2.481147 0.7253611   73 yes   high 1.28712357  0.668382608
##          x1         x2        x3    fac id       lon       lat
## 1 0.2875775 0.35360608 0.2736227   high  1 0.3181818 0.8636364
## 2 0.7883051 0.36644144 0.5938669 medium  2 0.6363636 0.3636364
## 3 0.4089769 0.28710013 0.1601848 medium  3 0.2727273 0.3636364
## 4 0.8830174 0.07997291 0.8534302 medium  4 0.5909091 0.9090909
## 5 0.9404673 0.36545427 0.8477392   high  5 0.4090909 0.7272727
## 6 0.0455565 0.17801381 0.4778868 medium  6 0.6818182 0.3636364
##             err      ID
## 1  0.0278713673 1 ID128
## 2 -0.1659429266  1 ID68
## 3  0.0004756581  1 ID65
## 4  0.0118152420 1 ID130
## 5  0.0985445686 1 ID104
## 6 -0.1628949195  1 ID69</code></pre>
<p>However, there is still a small problem, because not all coordinates could be assigned to polygons. Unfortunately we get some <code>NA</code>’s</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(d$ID))</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>To get around this, we could use a slightly increased convex hull and intersect once more with the hexagonal polygons.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hexpolys &lt;-<span class="st"> </span><span class="kw">HexPoints2SpatialPolygons</span>(pts)
hexpolys &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/rgeos/topics/topo-bin-gIntersection">gIntersection</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/rgeos/topics/misc-gBuffer">gBuffer</a></span>(hullpoly, <span class="dt">width =</span> <span class="fl">0.05</span>),
  hexpolys, <span class="dt">byid =</span> <span class="ot">TRUE</span>, <span class="dt">drop_lower_td =</span> <span class="ot">TRUE</span>)

## Note again, over() only returns the index of the polygons,
## but for the MRF we need the polygon names.
d$ID &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/plotmath">over</a></span>(<span class="kw">SpatialPoints</span>(d[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]), hexpolys)

## No more NA's.
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(d$ID))</code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Get the polygon names.
pn &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(hexpolys)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(pn))</code></pre></div>
<pre><code>## [1] "buffer ID14" "buffer ID15" "buffer ID16" "buffer ID17" "buffer ID18"
## [6] "buffer ID19"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Ok, we need to modify the names a bit.
pn &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">gsub</a></span>(<span class="st">"buffer ID"</span>, <span class="st">""</span>, pn)

## Set up new ID variable with names.
d$ID &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(pn[d$ID])</code></pre></div>
<p>To set up the final MRF smooth we need to construct the neighborhood information from the polygons. This can be done, e.g., by defining polygons as neighbors, that share a common border.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nb &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/spdep/topics/poly2nb">poly2nb</a></span>(hexpolys)</code></pre></div>
<p>Now, the neighborhood object <code>nb</code> can be used to construct the MRF penalty matrix that can be passed to the smooth constructor</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Compute 0/1 neigbhbormatrix.
P &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/spdep/topics/nb2mat">nb2mat</a></span>(nb, <span class="dt">style =</span> <span class="st">"B"</span>)

## Off diagonal entries are -1, diagonal entries
## count the number of neighbors for each region.
nn &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colSums">colSums</a></span>(P)
P &lt;-<span class="st"> </span>P *<span class="st"> </span>-<span class="dv">1</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/diag">diag</a></span>(P) &lt;-<span class="st"> </span>nn

## Set row and column names as in the identifier variable.
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(P) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(P) &lt;-<span class="st"> </span>pn</code></pre></div>
<p>Finally, this penalty matrix can be used so set up the MRF smooth term. However, this will still give an error, because due to the expansion of the convex hull, a couple of polygons do not have any observations, i.e., the dimension of the penalty matrix <code>P</code> will be too large at the moment, since not all polygon names are assigned levels in the <code>ID</code> variable in our data frame. To fix this we need to fill up the missing levels.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">i &lt;-<span class="st"> </span>!(pn %in%<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels</a></span>(d$ID))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels</a></span>(d$ID) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/levels">levels</a></span>(d$ID), pn[i])</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Smooth specification object.
st &lt;-<span class="st"> </span><span class="kw">s</span>(ID, <span class="dt">bs=</span> <span class="st">"mrf"</span>, <span class="dt">xt =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"penalty"</span> =<span class="st"> </span>P))

## Design and penalty constructor.
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(<span class="kw">smoothCon</span>(st, <span class="dt">data =</span> d, <span class="dt">knots =</span> <span class="ot">NULL</span>))</code></pre></div>
<pre><code>## List of 1
##  $ :List of 22
##   ..$ term          : chr "ID"
##   ..$ bs.dim        : int 115
##   ..$ fixed         : logi FALSE
##   ..$ dim           : int 1
##   ..$ p.order       : logi NA
##   ..$ by            : chr "NA"
##   ..$ label         : chr "s(ID)"
##   ..$ xt            :List of 1
##   .. ..$ penalty: num [1:115, 1:115] 2 0 0 0 0 0 0 0 0 -1 ...
##   .. .. ..- attr(*, "call")= language nb2mat(neighbours = nb, style = "B")
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:115] "14" "15" "16" "17" ...
##   .. .. .. ..$ : chr [1:115] "14" "15" "16" "17" ...
##   ..$ id            : NULL
##   ..$ sp            : NULL
##   ..$ X             : num [1:500, 1:115] 0 0 0 0 0 0 0 0 0 0 ...
##   .. ..- attr(*, "dimnames")=List of 2
##   .. .. ..$ : chr [1:500] "1" "2" "3" "4" ...
##   .. .. ..$ : chr [1:115] "x100" "x101" "x102" "x103" ...
##   .. ..- attr(*, "assign")= int [1:115] 1 1 1 1 1 1 1 1 1 1 ...
##   .. ..- attr(*, "contrasts")=List of 1
##   .. .. ..$ x: chr "contr.treatment"
##   ..$ plot.me       : logi FALSE
##   ..$ S             :List of 1
##   .. ..$ : num [1:115, 1:115] 0.25 -0.0833 0 0 0 ...
##   .. .. ..- attr(*, "dimnames")=List of 2
##   .. .. .. ..$ : chr [1:115] "100" "101" "102" "103" ...
##   .. .. .. ..$ : chr [1:115] "100" "101" "102" "103" ...
##   ..$ rank          : int 114
##   ..$ null.space.dim: int 1
##   ..$ knots         : Factor w/ 115 levels "100","101","102",..: 2 3 4 5 6 7 8 9 10 11 ...
##   ..$ df            : int 115
##   ..$ te.ok         : num 2
##   ..$ noterp        : logi TRUE
##   ..$ side.constrain: logi TRUE
##   ..$ C             : num [1, 1:115] 0 0.004 0.006 0.014 0.018 0.016 0.002 0.01 0.018 0.008 ...
##   ..$ S.scale       : num 12
##   ..- attr(*, "class")= chr [1:2] "mrf.smooth" "mgcv.smooth"</code></pre>
</div>
<div id="functional-random-intercepts" class="section level2">
<h2 class="hasAnchor">
<a href="#functional-random-intercepts" class="anchor"></a>Functional random intercepts</h2>
<p>This type of model term is basically a random intercept and slope term, where the functional type might be nonlinear, e.g., this type of term is heavily used in joint models for longitudinal and survival data <span class="citation">(Köhler et al. 2017; Köhler, Umlauf, and Greven 2018)</span>. Fortunately, using the <em>mgcv</em> package it is not very difficult to set them up. Using the artificial data from above, together with our newly created region identifier from the <a href="#mrfs">MRF</a> example, we can set up a functional random intercept using numeric variable <code>x1</code> and factor variable <code>ID</code> with</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">num ~<span class="st"> </span><span class="kw">ti</span>(ID,<span class="dt">bs=</span><span class="st">"re"</span>) +<span class="st"> </span><span class="kw">ti</span>(x1,<span class="dt">bs=</span><span class="st">"ps"</span>,<span class="dt">k=</span><span class="dv">10</span>) +<span class="st"> </span><span class="kw">ti</span>(ID,x1,<span class="dt">bs=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"re"</span>,<span class="st">"ps"</span>),<span class="dt">k=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nlevels">nlevels</a></span>(d$ID),<span class="dv">5</span>))</code></pre></div>
<p>where all nonlinear functions are modeled with P-splines <span class="citation">(Eilers and Marx 1996)</span>. One needs to be a little bit careful with the number of basis functions in the <code>ti()</code> smooth constructor since this can easily end up in thousands of parameters and problems with memory might occur (also, depending on the number of levels in the factor variable, here <code>ID</code>).</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-bamlss:Eilers+Marx:1996">
<p>Eilers, P. H. C, and B. D. Marx. 1996. “Flexible Smoothing Using B-Splines and Penalized Likelihood.” <em>Statistical Science</em> 11: 89–121. doi:<a href="https://doi.org/10.1214/ss/1038425655">10.1214/ss/1038425655</a>.</p>
</div>
<div id="ref-bamlss:Koehler+Umlauf+Greven:2018">
<p>Köhler, Meike, Nikolaus Umlauf, and Sonja Greven. 2018. “Nonlinear Association Structures in Flexible Bayesian Additive Joint Models.” <em>Statistics in Medicine</em> 37 (30): 4771–88. doi:<a href="https://doi.org/10.1002/sim.7967">10.1002/sim.7967</a>.</p>
</div>
<div id="ref-bamlss:Koehler+Umlauf+Greven:2016">
<p>Köhler, Meike, Nikolaus Umlauf, Andreas Beyerlein, Christiane Winkler, Anette-Gabriele Ziegler, and Sonja Greven. 2017. “Flexible Bayesian Additive Joint Models with an Application to Type 1 Diabetes Research.” <em>Biometrical Journal</em> 59 (6): 1144–65. doi:<a href="https://doi.org/10.1002/bimj.201600224">10.1002/bimj.201600224</a>.</p>
</div>
<div id="ref-bamlss:Umlauf+bamlss:2018">
<p>Umlauf, Nikolaus, Nadja Klein, Achim Zeileis, and Thorsten Simon. 2019. <em>Bamlss: Bayesian Additive Models for Location Scale and Shape (and Beyond)</em>. <a href="http://CRAN.R-project.org/package=bamlss" class="uri">http://CRAN.R-project.org/package=bamlss</a>.</p>
</div>
<div id="ref-bamlss:Wood:2018">
<p>Wood, S. N. 2019. <em>Mgcv: GAMs with Gcv/Aic/Reml Smoothness Estimation and Gamms by Pql</em>. <a href="https://CRAN.R-project.org/package=mgcv" class="uri">https://CRAN.R-project.org/package=mgcv</a>.</p>
</div>
<div id="ref-bamlss:Wood:2003">
<p>Wood, Simon N. 2003. “Thin Plate Regression Splines.” <em>Journal of the Royal Statistical Society. Series B (Statistical Methodology)</em> 65 (1). [Royal Statistical Society, Wiley]: 95–114. <a href="http://www.jstor.org/stable/3088828" class="uri">http://www.jstor.org/stable/3088828</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li><a href="#specification">Specification</a></li>
      <li><a href="#basics">Basics</a></li>
      <li><a href="#mrfs">Markov Random Fields</a></li>
      <li><a href="#functional-random-intercepts">Functional random intercepts</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Nikolaus Umlauf, Nadja Klein, Achim Zeileis, Thorsten Simon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
