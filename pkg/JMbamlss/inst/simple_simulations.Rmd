---
title: "Simple MJMs"
author: "Alex"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MFPCA)
library(tidyverse)
library(Matrix)
library(mvtnorm)
library(survival)
library(bamlss)
setwd("..")


# Data Generation
source("R/simMultiJM.R")
source("R/preprocessing.R")

# Helperfunction PCRE
source("R/eval_mfun.R")
source("R/pcre_smooth.R")

# Family Construction
source("R/mjm_bamlss.R")
source("R/MJM_transform.R")
source("R/opt_MJM.R")
source("R/opt_updating.R")
source("R/MJM_mcmc.R")
source("R/mcmc_proposing.R")
source("R/survint.R")

# Load models
load("inst/objects/indepri_models.Rdata")
```

## Idea

Start with simple simulation scenarios for a proof of concept. In particular, start with a multivariate joint model, where the intra-subject association of the longitudinal part is induced only by a random intercept. Then expand it further to more complex scenarios.

The proof of concept follows the outline:

- Data generation
- Data preparation
- Model formula
- Model fit
- Sampling statistics

## Random Intercept Model

### Model Specification

The following model is specified
\begin{equation}
h_i(t) = \text{exp}\{\eta_{\lambda i}(t) + \eta_{\gamma i}(x) + \eta_{\alpha_{1}i}\cdot\eta_{\mu_{1}i}(t,x)+\eta_{\alpha_{2}i}\cdot\eta_{\mu_{2}i}(t,x)\}\\
y_{ijk} = \eta_{\mu_{k}i} (t_{ijk}) + \epsilon_{ijk},\quad k = 1,2\\
\epsilon_{ijk}\overset{\text{iid}}{\sim} N(0, \exp\{\log (0.6)\}^2)
\end{equation}
with
\begin{align}
\eta_{\lambda i}(t) &= 1.37\cdot t^{0.37}\\
\eta_{\gamma i} &= -5.8 + 0.48\cdot x_i\\
\eta_{\alpha_{1} i} &= 0.64\\
\eta_{\mu_{1} i}(t,x) &= 2.13 + 0.24\cdot t - 0.25\cdot x_i - 0.5\cdot t\cdot x_i + b_{1i}\\
\eta_{\alpha_{2} i} &= -0.64\\
\eta_{\mu_{2} i}(t,x) &= 2.13 + 0.24\cdot t - 0.25\cdot x_i - 0.5\cdot t\cdot x_i + b_{2i}\\
\begin{pmatrix} b_{1i} \\ b_{2i}\end{pmatrix} &\sim N\left(\begin{pmatrix}0 \\ 0\end{pmatrix}, \begin{pmatrix}0.68 & 0 \\ 0 & 0.68 \end{pmatrix}\right)
\end{align}
where $i = 1,..., 150$, $t\in[0,25]$, and $x_i$ is a binary covariate.

Note that the longitudinal trajectories are the same except for the random intercept, but the association parameters have opposite signs.

The true baseline hazard (with gamma intercept) is given by
```{r, fig.height=4}
curve(1.37*x^0.37-5.8)
```


### Data Generation

```{r, fig.height=4}
# Generate data with independent random intercepts
d_indepri <- simMultiJM(nsub = 150, times = seq(0, 25, by = 0.25), 
                        probmiss = 0.75, maxfac = 1.5,
                        nmark = 2, param_assoc = TRUE, M = NULL, 
                        FPC_bases = NULL, FPC_evals = NULL, mfpc_args = NULL,
                        re_cov_mat = matrix(c(0.68, 0, 0, 0.68), ncol = 2), 
                        ncovar = 2,
                        lambda = function(t, x) {
                          1.37 * t^(0.37)
                        },
                        gamma = function(x) {
                          - 5.8 + 0.48*x[, 3]
                        },
                        alpha = list(function(t, x) {
                          0.64 + 0*t
                        }, function(t, x) {
                          -0.64 + 0*t
                        }),
                        mu = list(function(t, x, r){
                          2.13 + 0.24*t - 0.25*x[, 3] - 0.05*t*x[, 3] + 
                            r[, 1]
                        }, function(t, x, r){
                          2.13 + 0.24*t - 0.25*x[, 3] - 0.05*t*x[, 3] + 
                            r[, 2]
                        }),
                        sigma = function(t, x) {
                          log(0.6) + 0*t
                        }, 
                        tmax = NULL, seed = 1808, 
                        full = TRUE, file = NULL)

```

```{r, echo=FALSE}

ggplot(d_indepri$data, aes(x = obstime, y = y, color = id)) +
  geom_point() +
  geom_line(aes(y = mu)) +
  facet_grid(~marker) +
  theme(legend.position = "none")
```


### Model Fit

Specify and fit the model using a random intercept per marker
```{r, eval=FALSE}
f_indepri_byre <- list(
  Surv2(survtime, event, obs = y) ~ -1 + s(survtime, k = 10),
  gamma ~ 1 + x3,
  mu ~ -1 + marker + obstime:marker + x3:marker + obstime:marker:x3 +
    s(id, by = marker, bs = "re"),
sigma ~ -1 + marker,
alpha ~ -1 + marker
)

set.seed(1808)

b_indepri_byre <- bamlss(f_indepri_byre, family = mjm_bamlss, 
                          data = d_indepri$data, timevar = "obstime",
                          maxit = 1000, verbose_sampler = TRUE)
```


```{r, fig.heigt=4}
plot(b_indepri_byre, model = "lambda", ask = FALSE)
summary(b_indepri_byre)
```

Look at acceptance probabilities

```{r}
acc <- grep("accepted", colnames(b_indepri_byre$samples[[1]]))
summary(b_indepri_byre$samples[[1]][, acc])
```

